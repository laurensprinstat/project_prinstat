---
title: "R Notebook"
output: html_notebook
---



```{r}
library(plyr)
```


```{r}
# Read in data
data <- read.table("bptrial.txt", header=TRUE, sep=",", dec=".")
original <- data
# Set column names
colnames(data) <- c("treatment", "sex", "weight", "age",
                    "comp", "dbpdif", "dbp3", "dbp2", "dbp1")
# Add column dbp_end for the 5th measurement at the end of the experiment
data$dbp_end <- data$dbp3 + data$dbpdif
# Mean dbp during the run-in period
data$dbp_mean <- round((data$dbp1 + data$dbp2 + data$dbp3) / 3, 1)
# Raw data subset
data_raw <- data
# Treatment group as factor
data$treatment <- as.factor(mapvalues(
  data$treatment,
  from=c(1, 2, 3),
  to=c("Treatment 1", "Placebo", "Treatment 3")
))
# Gender as factor
data$sex <- as.factor(mapvalues(data$sex, from=c(0, 1), to=c("Female", "Male")))
# 80% adherence rule
data <- data[data$comp >= 0.8,]
# Subset of treatment 1 and the placebo
data12 <- data[data$treatment != "Treatment 3",]
```

## 2. 

```{r}
# Amount of possible permutations
choose(84, 42)
```

```{r}
# Get observed
t.obs_dif <- t.test(data12$dbpdif~data12$treatment)$statistic
t.obs_5 <- t.test(data12$dbp_end~data12$treatment)$statistic
t.obs_dif
t.obs_5
```

```{r}
#N <- 10000
#perm.data <- data12
#t.star.approx <- replicate(N,{
#  perm.data$group <- sample(perm.data$treatment)
#  test.perm <- t.test(dbpdif ~ group, data=perm.data)
#  return(test.perm$statistic)
#})
#criticalValues <- quantile(t.star.approx, probs=c(0.025, 0.975))
```

```{r}
N <- 10000
t.approx_dif <- rep(NA,N)
t.approx_5 <- rep(NA,N)
for(i in 1:N) {
  # Set seed for reproducibility
  set.seed(1991 + i + 400000)
  # Randomly assign treatment group
  perm.data$group <- sample(perm.data$treatment)
  # T-test for dbpdif and dbp5
  test_dif <- t.test(dbpdif~group, data=perm.data)
  test_5 <- t.test(dbp_end~group, data=perm.data)
  # Store T value
  t.approx_dif[i]<-test_dif$statistic
  t.approx_5[i]<-test_5$statistic
}
```

```{r}
mean(abs(t.approx_dif) >= abs(t.obs_dif))
mean(abs(t.approx_5) >= abs(t.obs_5))
```

# Asymptotic null distribution
```{r}
wilcox.test(dbpdif~treatment, data=data12, exact=FALSE, correct=FALSE)
wilcox.test(dbp_end~treatment, data=data12, exact=FALSE, correct=FALSE)
```

For both methods, the p-value is smaller when using the final DBP measure opposed to using the difference between DBP measures 3 and 5.

































































































