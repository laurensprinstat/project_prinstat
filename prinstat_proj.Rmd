title: "Randomized blood pressure reduction trial"
author: Robin Boudry, Maarten Rahier, Tom Schipper, Laurens Van Paemel
output:
  word_document:
    highlight: "tango"
    toc: yes
    toc_depth: 1
---

```{r}
library(ggplot2)
library(plyr)
library(Hmisc)
library(psych)
library(dplyr)
library(expss)
library(qwraps2)
library(corrplot)
library(reshape2)
library(stats)
library(car)
## Stargazer
options(qwraps2_markup = "markdown")
```

(RB): dose and compliance with the assigned dose not the same. Would prefer comp
```{r}
# Read in data
data <- read.table("bptrial.txt", header=TRUE, sep=",", dec=".")
# Set column names
colnames(data) <- c("treatment", "sex", "weight", "age", "dose", "dbpdif", "dbp3", "dbp2", "dbp1")
# Add column dbp_end for the 5th measurement at the end of the experiment
data$dbp_end <- data$dbp3 + data$dbpdif
# Mean dbp during the run-in period
data$dbp_mean <- round((data$dbp1 + data$dbp2 + data$dbp3) / 3, 1)
# Raw data subset without categorical variables as factor
data_raw <- data
# Treatment group as factor
data$treatment <- as.factor(data$treatment)
# Gender as factor
data$sex <- as.factor(mapvalues(data$sex, from=c(0, 1), to=c("female", "male")))
```


------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------


# Question 1

# 1 a) 
1. a) Check for any errors (obviously suspicious observations due to data entry errors, should be corrected if possible). Clarify in your report what mistakes you have detected, and how you detected them. All further questions below should be answered based on the cleaned data.

## Cleaning

No missing values

```{r}
# Missing value count
colSums(is.na(data))
```

No duplicates

```{r}
# Check for duplicate rows
data[duplicated(data),]
```

## Dosage

80% adherence cut-off rule

```{r}
summary(data$dose)
# Dose by treatment group
boxplot(data$dose~data$treatment, data=data, main="Dose by treatment group", xlab="Treatment group", ylab="Dose")
# Patients who didn't take pills at least 80% of the experimental days
data <- data[order(data$dose),]
data_low_dose <- data[data$dose < 0.8,]
data_low_dose
# Remove observations of patients who didn't take the prescribed medication for more than 40% of all experiment days.
data <- data[data$dose >= 0.6,]
data_raw <- data_raw[data_raw$dose >= 0.6,]
# Split treatment groups
treat1 <- data[data$treatment == 1,]
placebo <- data[data$treatment == 2,]
treat3 <- data[data$treatment == 3,]
```

(RB: titles added)
```{r}
corrplot.mixed(cor(data_raw %>% select(sex, weight, age, dose, dbp_mean, dbpdif, dbp_end)), lower="number", upper="ellipse", tl.pos="d")
# By treatment group
corrplot.mixed(cor(data_raw[data_raw$treatment == 1,] %>% select(sex, weight, age, dose, dbp_mean, dbpdif, dbp_end)), lower="number", upper="ellipse", tl.pos="d",title = '\n Treatment 1')
corrplot.mixed(cor(data_raw[data_raw$treatment == 2,] %>% select(sex, weight, age, dose, dbp_mean, dbpdif, dbp_end)), lower="number", upper="ellipse", tl.pos="d",title = '\n Treatment 2')
corrplot.mixed(cor(data_raw[data_raw$treatment == 3,] %>% select(sex, weight, age, dose, dbp_mean, dbpdif, dbp_end)), lower="number", upper="ellipse", tl.pos="d",title = '\n Treatment 3')
```

Taking a closer look at the correlation between the dosage and weight for the 3rd treatment group and dbp_mean vs dosage for the 1st treatment group.

(RB: had a negative remark on HW3 about using a regression line in the descriptive part. Use when 100% sure)
(RB: titles & cor# added)
```{r}
# Scatterplot with regression line - t3: weight vs dosage
plot(treat3$weight, treat3$dose, main = paste('Scatterplot with regression line - t3: weight vs dosage,
correlation is:',round(cor(treat3$weight, treat3$dose),3)))
     
abline(lm(treat3$dose~treat3$weight), col="red")
# Scatterplot with regression line - t1: dbp_mean vs dosage
plot(treat1$dbp_mean, treat1$dose, main = 'Scatterplot with regression line - t1: dbp_mean vs dosage')
abline(lm(treat1$dose~treat1$dbp_mean), col="red")
```

(lvp) Total dosage not always a whole number thus it seems likely that the dose might be influenced by certain factors. If the numbers were all whole the dosage differences would likely have been due to people taking an extra pill or not taking a pill on certain days.
(RB) 1 pill per day is an assumption? What is the value of *28, prop diff stays same? 
A proportion *28 gives an enlarged proportion, not necessarily an actual dose

```{r}
data$total_dose <- data$dose * 28
data[data$treatment == 1,]$total_dose
data[data$treatment == 2,]$total_dose
data[data$treatment == 3,]$total_dose
```

(lvp) the previous time 0.6 was (intended) to be applied to limit the bias applied to the correlation tests between dosage and other factors. (RB: ok thx)

```{r}
# Remove observations of patients who didn't take the prescribed treatment at least 80 % of the time
data <- data[data$dose >= 0.8,]
# Mention the bias that arises from the removal of observations
# Split treatment groups
treat1 <- data[data$treatment == 1,]
placebo <- data[data$treatment == 2,]
treat3 <- data[data$treatment == 3,]
```


(TS) 80% is indeed an arbitrary, but commonly used cut-off in clinical trials: "the vast majority of publications still classify patients in a dichotomous fashion based on an 80% adherence cut-off rule derived from pill count", from: https://academic.oup.com/eurheartj/advance-article/doi/10.1093/eurheartj/ehy377/5050879 I think that the cut-off should be chosen on the basis of common clinical practice and should be independend of the adherence observed in our trial, so I don't think we should use an outlier exclusion procedure. Instead, I changed the 0.6 above to 0.8. This excludes 29 patients (compared to 20 for the 60% cut-off).
(lvp) Weak correlaton between t1 dosage vs dbp_mean and t3 dosage vs weight. Strong enough to consider? If yes, difficult to set a cut-off range.

(RB: thanks for clarifying. Is over-adherence a thing?)


## DBP run-in period

-> replace extreme observation of 66 by the mean of the other two measures
(TS): I am not sure if we should do this. This value is indeed an extreme outlier that is strange, but not necessarily impossible. There is also an exremely high observation: one patient (nr. 148 in the original dataset) had a dbp3 value of 130, while dbp1 and dbp2 were 100 and 102. Although some elevation in this period is expected from the study design, this one seems very high and sudden. If we want to adapt the extremely low value, I think we should also adapt this high value or have a very strong argument for not doing so. I think I would actually prefer to leave the values as they are.
(lvp) The overall mean across the 3 measurements would be 89.33 while the selection criteria applied seems to be 90+. Which adds to the belief that itâ€™s an error. Normally I'd be ok with keeping it and at first I wanted to do that too, but not a single other patient has an average below 90. Thus it seems very odd from different perspectives.
(RB): Keeping could mean bias. Since the intake criteria was >= 90 I would agree with LVP

```{r}
# Diastolic bloodpressure below 90 during one of the measurements during the run-in period
data[data$dbp1 < 90 | data$dbp2 < 90 | data$dbp3 < 90,]
```

(RB) 101 is correct but plz make sure it doesnt seem arbitrary
(lvp) done 
```{r}
# Replace extreme observation
data$dbp3[data$dbp3 == 66] <- (data[data$dbp3 == 66,]$dbp1 + data[data$dbp3 == 66,]$dbp2) / 2
# Recalc the mean dbp
data$dbp_mean <- round((data$dbp1 + data$dbp2 + data$dbp3) / 3, 1)
```


```{r}
# Frequencies of measures
histogram(data$dbp1)
histogram(data$dbp2)
histogram(data$dbp3)
histogram(round(data$dbp_mean, 0))
```

------------------------------------------------------------------------------------------

# 1 b)
Describe the study population and hence the scope of the evaluation.

The study population consists of people who suffer from hypertension stage 2 (diastolic bloodpressure above 90). No other criteria seem to have been applied (age, weight, gender).

```{r}
library(moonBook)
mytable(treatment~.,data=data)
```

```{r}
library(tableone)
CreateTableOne(data=data)
```

```{r}
CreateTableOne(vars=c("age", "weight", "dose", "dbp1", "dbp2", "dbp3", "dbp_end", "dbpdif", "sex"), strata="treatment" , data=data, factorVars="")
```

The mean dbp is higher for the placebo group

```{r}
boxplot(data$dbp_mean~data$treatment, data=data, main="DBP by treatment group", xlab="Treatment group", ylab="DBP")
```

# 1 c)
1. (c) to help evaluate assumptions which facilitate subsequent analyses.

Are the groups comparable?
They seem to be quite comparable.

Normality?
DBP is skewed to the right
Because of the small sample size it's difficult to tell whether dbpdif is normally distributed or not

## Comparable groups?
(RB: values added)
```{r}
# Mean weight by treatment group
table(data$treatment, data$sex)

# Gender by treatment group
ggplot(data, aes(treatment, fill=sex)) +
  geom_bar(position="fill") +
  scale_y_continuous(labels = scales::percent, name ="Percentage") +
  ggtitle("Gender balance by treatment group")
  
```

```{r}
# Mean weight by treatment group
summary(data$weight~data$treatment)
# Weight by treatment group
boxplot(data$weight~data$treatment, data=data, main="Weight by treatment group", xlab="Treatment group", ylab="Weight")
```

```{r}
# Mean age by treatment group
summary(data$age~data$treatment)
# Age by treatment group
boxplot(data$age~data$treatment, data=data, main="Age by treatment group", xlab="Treatment group", ylab="Age")
```

```{r}
# Mean run-off DBP by treatment group
summary(data$dbp_mean~data$treatment)
# Age by treatment group
boxplot(data$dbp_mean~data$treatment, data=data, main="DBP mean by treatment group", xlab="Treatment group", ylab="DBP mean")
```

## Normality?

(TS) I think the best way to assess normality is by making QQ-plots:
Based on these, I would say that dbpdif and weight are normally distributed, while the others are not.
(lvp) Isn't this mainly of importance for the dbp measures? (in relation to the question: "to help evaluate assumptions which facilitate subsequent analyses")
(RB: shapiro test added)

```{r}
qqnorm(data$dbpdif)
qqnorm(data$dbp3)
qqnorm(data$dbp_end)
qqnorm(data$age)
qqnorm(data$weight)

shapiro.test(data$dbpdif) 
#non normal as opposed to shapiro.test(rnorm(100, mean = 1, sd = 1))
```


```{r}
describe(data) 
```

```{r}
# Histograms of dbpdif per treatment group
par(mfrow=c(1,3))
histogram(treat1$dbpdif, breaks=seq(-35,5,5))
histogram(placebo$dbpdif, breaks=seq(-25,25,5))
histogram(treat3$dbpdif, breaks=seq(-45,10,5))
par(mfrow=c(1,1))
```

## Outliers?

Has already been examined earlier


------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------


# Question 2
(RB) please consider making a selection of what we will actually use

(RB) describe has been used just before for all data
```{r}
describeBy(data %>% select(dbp_mean, dbp1, dbp2, dbp3, dbp_end, dbpdif), group=data$treatment)
```

```{r}
# Custom summary table using dplyr (use this one) - format 1
summarycols <-
  list(
    "Run-in mean DBP" =
      list(
        "mean (sd)" = ~ qwraps2::mean_sd(dbp_mean),
        "min" = ~ min(dbp_mean),
        "25th" = ~ quantile(dbp_mean, .25),
        "Median" = ~ median(dbp_mean),
        "75th" = ~ quantile(dbp_mean, .75),
        "max" = ~ max(dbp_mean)
      ),
    "Final DBP" =
      list(
        "mean (sd)" = ~ qwraps2::mean_sd(dbp_end),
        "min" = ~ min(dbp_end),
        "25th" = ~ quantile(dbp_end, .25),
        "Median" = ~ median(dbp_end),
        "75th" = ~ quantile(dbp_end, .75),
        "max" = ~ max(dbp_end)
      ),
    "DBP change" =
      list(
        "mean (sd)" = ~ qwraps2::mean_sd(dbp_mean),
        "min" = ~ min(dbp_mean),
        "25th" = ~ quantile(dbp_mean, .25),
        "Median" = ~ median(dbp_mean),
        "75th" = ~ quantile(dbp_mean, .75),
        "max" = ~ max(dbp_mean)
      )
  )
print(summary_table(dplyr::group_by(data, treatment), summarycols),
      rtitle = "Summary Statistics",
      cnames = c("Treatment 1", "Placebo", "Treatment 3"))
```

```{r}
# Columns to rows
data_pop <- melt(data, id.vars='treatment', measure.vars=c('dbp_mean', 'dbp_end', 'dbpdif'))
data_pop$ID <- seq.int(nrow(data))
# Custom summary table using dplyr (use this one) - format 2
summarycols <-
  list(
    "treatment1" =
      list(
        "mean (sd)" = ~ qwraps2::mean_sd(data_pop[data_pop$treatment == 1 & data_pop$variable == variable,]$value),
        "min" = ~ min(data_pop[data_pop$treatment == 1 & data_pop$variable == variable,]$value),
        "25th" = ~ quantile(data_pop[data_pop$treatment == 1 & data_pop$variable == variable,]$value, .25),
        "Median" = ~ median(data_pop[data_pop$treatment == 1 & data_pop$variable == variable,]$value),
        "75th" = ~ quantile(data_pop[data_pop$treatment == 1 & data_pop$variable == variable,]$value, .75),
        "max" = ~ max(data_pop[data_pop$treatment == 1 & data_pop$variable == variable,]$value)
      ),
    "placebo" =
      list(
        "mean (sd)" = ~ qwraps2::mean_sd(data_pop[data_pop$treatment == 2 & data_pop$variable == variable,]$value),
        "min" = ~ min(data_pop[data_pop$treatment == 2 & data_pop$variable == variable,]$value),
        "25th" = ~ quantile(data_pop[data_pop$treatment == 2 & data_pop$variable == variable,]$value, .25),
        "Median" = ~ median(data_pop[data_pop$treatment == 2 & data_pop$variable == variable,]$value),
        "75th" = ~ quantile(data_pop[data_pop$treatment == 2 & data_pop$variable == variable,]$value, .75),
        "max" = ~ max(data_pop[data_pop$treatment == 2 & data_pop$variable == variable,]$value)
      ),
    "treatment3" =
      list(
        "mean (sd)" = ~ qwraps2::mean_sd(data_pop[data_pop$treatment == 3 & data_pop$variable == variable,]$value),
        "min" = ~ min(data_pop[data_pop$treatment == 3 & data_pop$variable == variable,]$value),
        "25th" = ~ quantile(data_pop[data_pop$treatment == 3 & data_pop$variable == variable,]$value, .25),
        "Median" = ~ median(data_pop[data_pop$treatment == 3 & data_pop$variable == variable,]$value),
        "75th" = ~ quantile(data_pop[data_pop$treatment == 3 & data_pop$variable == variable,]$value, .75),
        "max" = ~ max(data_pop[data_pop$treatment == 3 & data_pop$variable == variable,]$value)
      )
  )
print(summary_table(dplyr::group_by(data_pop, variable), summarycols),
      rtitle = "Summary Statistics",
      cnames = c("dbp_mean", "dbp_end", "dbpdif"))
```

```{r}
# Histogram comparison of the final dbp by treatment group
ggplot(data, aes(x=dbp_end)) +
  geom_histogram() +
  facet_grid(~treatment) +
  stat_bin(binwidth=5)
```

```{r}
# Columns to rows
data_res <- melt(data, id.vars='treatment', measure.vars=c('dbp_mean','dbp_end'))
data_res$ID <- seq.int(nrow(data))
# Boxplots of placebo and treatment3 before and after the experiment
ggplot(data_res[data_res$treatment != 1,], aes(x=treatment, y=value, fill=variable)) +
  geom_boxplot()
```

Checking the consistency of the decrease in dbp measurements for the 3rd treatment group: not all measures follow the trend

```{r}
# Profile plot
ggplot(data_res[data_res$treatment == 3,], aes(x=variable, y=value, group=ID)) +
  geom_point() +
  geom_line()
```

(TS) I would use the dbp3 or the mean of dbp2 and dpb3, but not the mean of dbp 1-3. dbp1 is measured at the moment that previous medication is disontinued, so it is influenced by the previous medication. 
(lvp) In the exploration no difference was seen between dbp1-3. I haven't done a signifiance test but I very highly doubt it would be. For example profile plot below. The mean should thus give a more reliable base measure. dbpdif compared between mean and dbp5 likely would also be more consistent.

```{r}
# Columns to rows
data_res <- melt(data, id.vars='treatment', measure.vars=c('dbp1','dbp2','dbp3'))
data_res$ID <- seq.int(nrow(data))
# Profile plot
ggplot(data_res, aes(x=variable, y=value, group=ID)) +
  geom_point() +
  geom_line()
```

I would also make a more stringent selection of the values that we want to represent, because mean, sd, min, Q2, median, Q3 and max for every variable is really a lot. If we select certain values, we can show that we have considered which values are important for the reader and which values fit the data. My selection would be to represent the median and IQR for dbp3 and dbp_end, as these are not normally distributed, and mean and sd for dbpdif, as it is normally distributed. My (primitive) table would look like this:
(lvp) Would suggest using the table as in the word doc. This one matches the ones typically shown in scientific articles.

```{r}
table_dbp3 <- with(data, tapply(dbp3, treatment, function(x) 
  paste0(round(mean(x)), " (", IQR(x), ")")))
table_dbp_end <- with(data, tapply(dbp_end, treatment, function(x) 
  paste0(round(mean(x)), " (", IQR(x), ")")))
table_dbpdif <- with(data, tapply(dbpdif, treatment, function(x) paste(round(mean(x)), "Â±", round(sd(x)))))
table_all <- noquote ( t( rbind(table_dbp3, table_dbp_end, table_dbpdif)))
rownames(table_all) <- c("Traetment 1", "Placebo", "Treatment 3")
colnames(table_all) <- c("dbp3 - median (IQR)", "dbp5 - median (IQR)", "dpbdif - mean Â± sd")
table_all
```

(RB) ## Question 2: descriptive analysis of the research question
Initial conclusion after
```{r}
#Research question: difference between treatment groups
#look at treatment groups
#final difference
#control around 0, other dropped by 10 median in final condition
#at start1, we can see at visit 1, little to no difference 
#upper range for control is somewhat larger  
summary(data)
#graph 
par(mfrow=c(1,4)) 
plot(data$treatment, data$dbp1,
     ylim=c(70, 130))  # we can see at visit 1, little to no difference
title('Dbp at Visit 1') 
plot(data$treatment, data$dbp2,
     ylim=c(70, 130)) #same trend visit 2
title('Dbp at Visit 2')
plot(data$treatment, data$dbp3,
     ylim=c(70, 130)) #same trend visit 3
title('Dbp at Visit 3')
plot(data$treatment, data$dbp_end,
     ylim=c(70, 130)) #same trend visit 3
title('Dbp at Visit 5')
par(mfrow=c(1,1)) 
```
Conclusion q2: At first glance we can see that the groups had a similar bp at intake visits, but the treatment groups(1,3)
had a lower bp than before at the final visit. The control group(2) remained more or less stable throughout the study. 
We can see this as a first indication that the treatment groups did achieve a lower bp.

TS: Dit is wat ik gedaan had voor Q2 (waarschijnlijk veel overlap, maar voor de volledigheid):

-Data inlezen en aanpassen
```{r}
data <- read.csv("C:/Data/PhD/Statistiek/Project/bptrial.txt")
data$dbp5 <- data$dbp3 + data$dbpdif
data$trt <- as.factor(as.character(data$trt))
data$sex <- as.factor(as.character(data$sex))
colnames(data) <- c("treatment", "sex", "weight", "age", "active_dose", "dbpdif", "dbp3", "dbp2", "dbp1","dbp5")
levels(data$treatment) <- c("Treatment 1", "Placebo", "Treatment 3")

-Boxplot van de resultaten in de verschillende behandelingsgroepen maken

boxplot(data$dbpdif~data$treatment, data=data, main="Differences in diastolic blood pressure", xlab= "Treatment group",
        ylab="Blood pressure difference (mmHg)")
```

-Tabel van gemiddelden en standaardeviaties van de verschillende groepen maken (ook voor de geslachten apart)
```{r}
table_total <- with(data, tapply(dbpdif, treatment, function(x) paste(round(mean(x)), "Â±", round(sd(x)))))
table_male <- with(data[which(data$sex == 1),], tapply(dbpdif, treatment, function(x) 
  paste(round(mean(x)), "Â±", round(sd(x)))))
table_female <- with(data[which(data$sex == 0),], tapply(dbpdif, treatment, function(x) 
  paste(round(mean(x)), "Â±", round(sd(x)))))
table_all <- noquote (rbind(table_total, table_male, table_female))
rownames(table_all) <- c("Total", "Male", "Female")
write.table(noquote(table_all), "table.txt", quote = FALSE, sep = ",", row.names = TRUE, col.names = NA)
```

------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------


# Question 3

## Parametric

TS In this question and question 4 we test two-sided, but in question 5 we test one-sided. The questions do not explicitly say that treatment 3 should have a greater difference, so we can test two-sided. On the other hand, the purpose of this experiment is to find a treatment that causes a greater reduction then the placebo, which implies one sided testing. I think that both can be used if supported by good arguments, but we must make sure that we use the same in question 3, 4 and 5.
My preference would be to test one-sided. As the questions are "suggesting natural steps", I think we do not have to take them literally, but can choose what we think fits the research question best. What do you think?
(lvp) Looking at the boxplot earlier it suggests that the treatment 3 group has a lower final dbp, thus raising the question: is the dbp significantly lower compared to the placebo? "There is a significant difference" doesn't really help us out with the question of whether the treatment is an improvement or not -> thus I'm also in the 1-way camp.

(RB) 1. is dbp lower '1-sided'. 2. is there a male/female dif '2-sided'


Welch Two Sample t-test
H0: The difference in diastolic blood pressure is equal in both the third treatment group and the placebo group.
Ho: mean(third treatment) - mean(placebo) = diff = 0
Ha: The difference in dialostic blood pressure is bigger in the third treatment group compared to the placebogroup.
Ha: mean(third treatment) - mean(placebo) = diff != 0

```{r}
mean(placebo$dbpdif)
mean(treat3$dbpdif)
boxplot(treat3$dbpdif,placebo$dbpdif)
t.test(treat3$dbpdif, placebo$dbpdif, mu=0, alternative = "two.sided", conf= 0.95, var.eq=F, paired=F)
```
Difference when treament 3 is used is bigger. The diastolic blood pressure decreases significantly more when using Treament 3.
Assumptions: 
scale of measurement, random sampling, normality of data distribution, adequacy of sample size -> Scale is not that large, not sure about normal distribution of both populations

## Non-parametric
Mann-Whitney U test (because we are not sure about the normal distribution of both populations)
Only one assumption, Samples are independent and randomly drawn
```{r}
wilcox.test(treat3$dbpdif, placebo$dbpdif, mu = 0, alt="two.sided", correct= TRUE, paired = FALSE, conf.int = TRUE, exact =FALSE)
```
Same conclusion. The diastolic blood pressure decreases significantly more when using Treament 3.
In this case I think it is best to use Mann-Whitney since we are not sure about the normal distribution.

TS: Ik zet hier gewoon mijn code tussen, waarschijnlijk overlapt het heel erg met het vorige, maar wie weet halen we er nog iets nuttigs uit.

Nieuw object maken dat enkel data van groepen 2 en 3 bevat
```{r}
data23 <- data[which(data$treatment != "Treatment 1"),]
data23$treatment <- droplevels(data23$treatment)

#QQ-plot maken
qqnorm(data23$dbpdif)
qqline(data23$dbpdif)
```

Varianties vergelijken
```{r}
variances <- with(data23, tapply(dbpdif, treatment, function(x) round( var(x), digits = 2) ) )

#Varianties testen
print(bartlett.test(dbpdif~treatment,data = data23))

#Parametrisch testen met T-test
print(t.test(dbpdif~treatment, data = data23, alternative = "greater"))

#non=parametrisch testen met Mann-Whitney U test
print(wilcox.test(formula = dbpdif~treatment, data = data23, alternative = "greater", exact = FALSE))
```

------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------


# Question 4
## Parametric
T-test
Power of the T-test for gender difference of >=4mmHg in the treatment effect
Here 2 sample T, comparing 2 group means to each other
```{r}
#male group
male <- data[data$sex == 'male',]
#female group
female <- data[data$sex == 'female',]
#get variables mean, sd, n,
m1 <- mean(male$dbp_end)
m2 <- mean(female$dbp_end)
sd1 <- sd(male$dbp_end)
sd2 <- sd(female$dbp_end)
num1 <- length(male$dbp_end)
num2 <- length(female$dbp_end)
n <- c(num1,num2)
mean <- c(m1,m2)
sd <- c(sd1,sd2)

#equal var?
var.test(dbpdif~sex, data)

df <- data.frame(n,mean,sd)
pooled_sd <- sqrt( sum(df$sd^2 * (df$n - 1)) / (sum(df$n - 1)) )


power.t.test(n= num1 + num2, #size
             delta = 4, #effect size
             sd = pooled_sd, # use pooled sd, is wrong will update
             sig.level = 0.95,
             type= "two.sample", #male & female
             alternative = 'two.sided' #detect a difference
             )


alpha<-0.05
theta<-4
mu<- mean(data$dbpdif)
n<- length(data)
var <- var(data$dbpdif)
crit.l <- qnorm(alpha/2, mu, sqrt(var/ n))    ## Critical Value Based on Null
crit.h <- qnorm(1-alpha/2, mu, sqrt(var/ n))  ## Critical Value Based on Null
pr.high <- pnorm(crit.h, theta, sd = sqrt(var/ n),lower.tail<-FALSE) ## Prob Reject High
pr.low  <- pnorm(crit.l, theta, sd = sqrt(var/ n))                  ## Prob Reject Low
pow <- pr.low+pr.high

pow


#both have ~ same conclusion 
```
The power to detect a difference of 4hhMg at the 0.05 sign level between male and female using the T-test is 0.97


## Non-parametric
Power here has to be calculated as a proportion, since we can not use the normal distribution to make inferences
Do the wilcox test for 1000 samples of random generated data with length, mean and sd as the male and female group to compare. See proportion of p-values smaller than 0.05
```{r}
pval <- replicate(1000, 
                  wilcox.test(rnorm(num1,m1,sd1), #male
                              rnorm(num2,m2,sd2), #female
                              mu=4,alt="two.sided", correct= TRUE, 
                              paired = FALSE, conf.int = TRUE, 
                              exact =FALSE)$p.value)      #mean difference to be detected
summary(pval) 
sum(pval < .05)/1000
```
The power decreases severely to 0.515 using this non parametric test


------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------



# Question5
Binary indicator of whether (dbp5-dbp3)<10mmHg between the 2 treatment arms.
Use appropriate 5% sign level & conclude, how and why do treatment arms differ?
How does this comparison differ from the one above?

## parametric
```{r}
#make binary variable
data23$binary <- 0
data23$binary[data23$dbpdif<10]<-1
binTr <-data23[data23$treatment == 'Treatment 3',]$binary
binPl <-data23[data23$treatment == 'Placebo',]$binary

##TS: I don't think that a T-test is suitable, as binary data are not (by definition, I think) normally distributed
##RB: Good remark

#using a t-test
# print(t.test(binary~treatment, 
#              data = data23, 
#              alternative = "less")
#              )#since Placebo comes first in data23, x1 less x2
# #function for calculatin the Z-statistic of 2 binary variables
# #with x=succes(1) and n=total(number 0 & 1's)
# z.prop = function(x1,x2,n1,n2){
#   numerator = (x1/n1) - (x2/n2)
#   p.common = (x1+x2) / (n1+n2)
#   denominator = sqrt(p.common * (1-p.common) * (1/n1 + 1/n2))
#   z.prop.ris = numerator / denominator
#   return(z.prop.ris)
# }
# binTr <-data23[data23$treatment == 'Treatment 3',]$binary
# binPl <-data23[data23$treatment == 'Placebo',]$binary
# pasTr <- sum(binTr)
# pasPl <- sum(binPl)
# nTr <- length(passTr) 
# nPl <- length(passPl)
# z.prop(pasTr, pasPl, nTr, nPl)      #optional
```


#non-parametric
use of prop.test from base R
H0: proportions in the groups are the same
```{r}
prop.test(c(pasTr,pasPl),
          c(nTr,nPl),
          alternative = 'greater' #has treatment 3 greater prop of 1's? (data23$dbpdif<10]<-1)
          )
#qchisq(0.9, 1)
```
We see that at the 0.05 accuracy rate we can't reject H0, but at the 0.06 rate we can. Although not overwhelming, we have some indication of Treatment 3 group measures being more below the 10 mmGh limit than placebo measures with this non-parametric test.

The treatments were compared here on a cut-off value of {dbp5-dbp3)<10mmHg}. Instead of comparing the natural group means, we created a yes or no indicator according to our set benchmark. The strength of this test will rely hugely on how well the cut-off value is chosen, and can not be seen as a complete representation of the difference between the groups. Only the difference in relation to the cut-off can be evalueted here.


------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------


# Question 6

expected evolution in blood pressure between visit 5 en 3 in the placebo group.

```{r}
mean(placebo$dbpdif)
hist(placebo$dbpdif)
```

Test if mean for Placebo group is different from 0. 
H0: mean difference for placebo group is equal to 0
H1: mean difference for placebo group is not equal to 0

## Parametric
using one sample t-test
```{r}
t.test(placebo$dbpdif)
```

We do not reject the 0 hypothesis, so we expect no difference in bloodpressure between visit 5 an visit 3 in the placebo group. This shows that the effect of treat 1 and 3 can not be dedicated to a placebo effect.
We could also use a paired t-test to compare dbp3 with dbp5; gives exactly the same results.

## Non-parametric
using one sample Wilcoxon test

```{r}
#Samples do not need to be drawn from a population with a normal distribution
qqnorm(placebo$dbpdif)
qqline(placebo$dbpdif)
wilcox.test(placebo$dbpdif, mu=0)
```
Same conclusion: H0 is not rejected, mean is not different from zero. No placebo effect.


------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------


## Question 7 

Does the mean difference in dbpdif between group 3 and group 2 depend on gender? Derive a justified answer.
2-way anova to see a possible interaction between treat and gender.

```{r}
str(treat3)
```

```{r}
#Nieuw object maken dat enkel data van groepen 2 en 3 bevat
data23 <- data[which(data$treatment != "1"),]
data23$treatment <- droplevels(data23$treatment)
data23$treatment <- as.factor(data23$treatment)
```

## Visualization

```{r}
#(!require(devtools)) install.packages("devtools")
#devtools::install_github("kassambara/ggpubr")
str(data23)
library(ggpubr)
plot <- ggline(data23, x = "treatment", y = "dbpdif", color = "sex",
               add = c("mean_se", "dotplot"),
               palette = c("#00AFBB", "#E7B800"))
plot
```
Two-way ANOVA with interaction
Interaction = the effect of one factor on the dependent variable depends on the level of another factor
```{r}
model1 <- lm(dbpdif ~ sex * treatment, data = data23)
anova(model1)
#type 1 because we are interested in the interaction
```

There is no interaction, so the mean difference between group 3 and 2 does not depend on gender.

## Check assumptions of the model
```{r}
#Assumption 1 : Normal distribution of the model residuals
plot(model1,2)
```
Residuals approximatly normally distributed.

```{r}
#Assumption 2: Homogeneity of variance of the groups
plot(model1,1)
leveneTest(dbpdif ~ sex * treatment, data = data23)
```
P-value is larger than 0.05 so variances are approximatly equal.
Both assumptions are met.

TS: I don't think we are allowed to use ANOVA, as this was no part of the Prinstat course. However, I found it very hard to find a suitable alternative in the things we have seen in prinstat. The main problem was that the sample size for the treatment and placebo group are not equal within one gender. This is what I tried, but I'm not very satisfied about it:
data23 <- data[data$treatment != "1",]
male23 <- data23[data23$sex =="male",]
female23 <- data23[data23$sex == "female",]
summary(male23$treatment) #Smallest group (2) has 19 values
summary(female23$treatment) #Smallest group (3) has 20 values

Making a vector with the differences, taking a sample from the largest group for equal group sizes
male23_dif <- male23$dbpdif[male23$treatment == 3] - sample(male23$dbpdif[male23$treatment == 2], size = 19)
female23_dif <- sample(female23$dbpdif[female23$treatment == 3], size = 20) - female23$dbpdif[female23$treatment == 2]

Variances seem comparable
var(male23_dif)
var(female23_dif)

Formal test for equality of variance
md2 <- data.frame(male23_dif, rep("m", 19))
fd2 <- data.frame(female23_dif, rep("f", 20))
colnames(md2) <- c("dif", "sex")
colnames(fd2) <- c("dif", "sex")
mfd <- rbind(md2, fd2)
mf23_dif <- c(male23_dif, female23_dif)
var.test(dif~sex, mfd)

Two-sided T-test
t.test(male23_dif, female23_dif, alternative = "two.sided", paired = FALSE, var.equal =  TRUE)

T-test that does not assume equality of variance generates almost the same result
t.test(male23_dif, female23_dif, alternative = "two.sided", paired = FALSE, var.equal =  FALSE)


------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------


## Question 7 (updated version of the project): power of the last question
alpha <- 0.025
delta <- 4
sigma1 <- var(male23_dif)
sigma2 <- var(female23_dif)
n1 <- length(male23_dif)
n2 <- length(female23_dif)
n <- n1 + n2
t.alpha <- qt(1-alpha,df = n-2)

lambda <- delta / sqrt(sigma1/n1 + sigma2/n2)

power <- pt(t.alpha, df = n-1, ncp = lambda )
