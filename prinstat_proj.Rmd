---
title: "Randomized blood pressure reduction trial"
author: Robin Boudry, Maarten Rahier, Tom Schipper, Laurens Van Paemel
output:
  word_document:
    highlight: "tango"
    toc: yes
    toc_depth: 1
---

```{r}
library(ggplot2)
library(plyr)
library(Hmisc)
library(psych)
library(dplyr)
library(expss)
library(qwraps2)
options(qwraps2_markup = "markdown")
```

```{r}
# Read in data
data <- read.table("bptrial.txt", header=TRUE, sep=",", dec=".")

# Set column names
colnames(data) <- c("treatment", "sex", "weight", "age", "dose", "dbpdif", "dbp3", "dbp2", "dbp1")

# Add column dbp5 (measurement at the end of the experiment)
data$dbp_end <- data$dbp3 + data$dbpdif

# Mean dbp during the run-off period
data$dbp_mean <- round((data$dbp1 + data$dbp2 + data$dbp3) / 3, 1)

# Treatment group as factor
data$treatment <- as.factor(data$treatment)

# Gender as factor
data$sex <- as.factor(mapvalues(data$sex, from=c(0, 1), to=c("female", "male")))
```

# Question 1

1. a) Check for any errors (obviously suspicious observations due to data entry errors, should be corrected if possible). Clarify in your report what mistakes you have detected, and how you detected them. All further questions below should be answered based on the cleaned data.

The active dose, denoting the amount of pills taken a day is given for each group. However, the data suggests that a number of patients didn't take the prescribed pills for extended periods of time. Before removing observations of patients who didn't follow the prescribed treatment plan, the relation between the active dose and weight, age and dbp is examined to explore whether the dosage assigned to each patient might vary according to one of these variables. There's a weak positive linear relationship between mean dbp measure during the run-off period and the dosage in the first experimental group (correlation coefficient of 0.28), which suggests higher dosages might have been prescribed based on the bloodpressure. However, the total dosage taken during the span of the experiment is consistently a whole number, suggesting that each pill was equally dosed and that some patients simply popped a pill extra or less on a few occasions. It is unknown whether patients were told not to take a pill when their dbp was low or an extra pill when it was very high. Based on this, any patients whose total dosage during the experiment was lower than 80% of the prescribed dosage have been removed.

## Cleaning

```{r}
# Missing value count
colSums(is.na(data))
```


## Dosage
-> remove observations with a dosage below 0.8

```{r}
summary(data$dose)

# Dose by treatment group
boxplot(data$dose~data$treatment, data=data, main="Dose by treatment group", xlab="Treatment group", ylab="Dose")

# Patients who didn't take pills at least 60% of the experimental days
data <- data[order(data$dose),]
data_low_dose <- data[data$dose < 0.6,]
data_low_dose

# Remove observations of patients who didn't take the prescribed medication for more than 40% of all experiment days.
data <- data[data$dose >= 0.6,]
```


```{r}
# Correlation coefficient all
cor(data$weight, data$dose)
cor(data$weight, data$dbp_mean)
cor(data$weight, data$age)

# Correlation by treatment group - weight
cor(treat1$weight, treat1$dose)
cor(placebo$weight, placebo$dose)
cor(treat3$weight, treat3$dose)

# Correlation by treatment group - age
cor(treat1$age, treat1$dose)
cor(placebo$age, placebo$dose)
cor(treat3$age, treat3$dose)

# Correlation by treatment group - dbp mean
cor(treat1$dbp_mean, treat1$dose)
cor(placebo$dbp_mean, placebo$dose)
cor(treat3$dbp_mean, treat3$dose)
```

```{r}
# Scatterplot
plot(treat1$dbp_mean, treat1$dose)
# Regression line
abline(lm(treat1$dose~treat1$dbp_mean), col="red")
```

```{r}
treat1$total_dose <- treat1$dose * 28
treat1$total_dose
```

```{r}
data <- data[data$dose >= 0.8,]

# Split treatment groups
treat1 <- data[data$treatment == 1,]
placebo <- data[data$treatment == 2,]
treat3 <- data[data$treatment == 3,]
```

## DBP run-in period
-> replace extreme observation of 66 by the mean of the other two measures

```{r}
# Diastolic bloodpressure below 90 during one of the measurements during the run-in period
data[data$dbp1 < 90 | data$dbp2 < 90 | data$dbp3 < 90,]
```

```{r}
# Replace extreme observation
data$dbp3[data$dbp3 == 66] <- 101
# Recalc the mean dbp
data$dbp_mean <- round((data$dbp1 + data$dbp2 + data$dbp3) / 3, 1)
```

```{r}
# Frequencies of measures
count(data$dbp1)
count(data$dbp2)
count(data$dbp3)
count(round(data$dbp_mean, 0))
histogram(round(data$dbp_mean, 0), breaks=seq(85,125,1))
```

1. (b) Describe the study population and hence the scope of the evaluation.

The study population consists of people who suffer from hypertension stage 2 (diastolic bloodpressure above 90). No other criteria seem to have been applied (age, weight, gender).

```{r}
# Age by treatment group
boxplot(data$dbp_mean~data$treatment, data=data, main="DBP by treatment group", xlab="Treatment group", ylab="DBP")
```

1. (c) to help evaluate assumptions which facilitate subsequent analyses.

Are the groups comparable?
They seem to be quite comparable.

Normality?
DBP is skewed to the right

## Comparable groups?

```{r}
# Gender by treatment group
ggplot(data, aes(treatment, fill=sex)) +
  geom_bar(position="fill") +
  scale_y_continuous(labels = scales::percent, name ="Percentage") +
  ggtitle("Gender balance by treatment group")
```

```{r}
# Mean weight by treatment group
summary(data$weight~data$treatment)

# Weight by treatment group
boxplot(data$weight~data$treatment, data=data, main="Weight by treatment group", xlab="Treatment group", ylab="Weight")
```

```{r}
# Mean age by treatment group
summary(data$age~data$treatment)

# Age by treatment group
boxplot(data$age~data$treatment, data=data, main="Age by treatment group", xlab="Treatment group", ylab="Age")
```

```{r}
# Mean run-off DBP by treatment group
summary(data$dbp_mean~data$treatment)

# Age by treatment group
boxplot(data$dbp_mean~data$treatment, data=data, main="Age by treatment group", xlab="Treatment group", ylab="DBP mean")
```

## Normality?

```{r}
describe(data) 
```

```{r}
histogram(round(data$dose, 2), breaks=seq(0.8,1.40,0.05))
```

```{r}
histogram(round(data$dbp_mean, 2), breaks=seq(90,130,1))
```

# Question 2

```{r}
describe.by(data %>% select(dbp_mean, dbp1, dbp2, dbp3, dbp_end, dbpdif), group=data$treatment)
```

```{r}
# Summary stats using the expss package (not very good)
data %>% 
  tab_cells(dbp_mean, dbp_end, dbpdif) %>%
  tab_cols(total(label="Total"), treatment) %>%
  tab_stat_fun(Mean = w_mean, "Std. dev." = w_sd, method = list) %>%
  tab_last_sig_means(subtable_marks = "both") %>%
  tab_pivot() %>% 
  htmlTable(caption = "Table with summary statistics and significance marks.")
```

```{r}
# Custom summary table using dplyr (use this one)
summarycols <-
  list(
    "Run-in mean DBP" =
      list(
        "mean (sd)" = ~ qwraps2::mean_sd(dbp_mean),
        "min" = ~ min(dbp_mean),
        "25th" = ~ quantile(dbp_mean, .25),
        "Median" = ~ median(dbp_mean),
        "75th" = ~ quantile(dbp_mean, .75),
        "max" = ~ max(dbp_mean)
      ),
    "Final DBP" =
      list(
        "mean (sd)" = ~ qwraps2::mean_sd(dbp_end),
        "min" = ~ min(dbp_end),
        "25th" = ~ quantile(dbp_end, .25),
        "Median" = ~ median(dbp_end),
        "75th" = ~ quantile(dbp_end, .75),
        "max" = ~ max(dbp_end)
      ),
    "DBP change" =
      list(
        "mean (sd)" = ~ qwraps2::mean_sd(dbp_mean),
        "min" = ~ min(dbp_mean),
        "25th" = ~ quantile(dbp_mean, .25),
        "Median" = ~ median(dbp_mean),
        "75th" = ~ quantile(dbp_mean, .75),
        "max" = ~ max(dbp_mean)
      )
  )

print(summary_table(dplyr::group_by(data, treatment), summarycols),
      rtitle = "Summary Statistics",
      cnames = c("Treatment 1", "Placebo", "Treatment 3"))
```

```{r}
ggplot(data, aes(x=dbp_end)) +
  geom_histogram() +
  facet_grid(~treatment) +
  stat_bin(binwidth=5)
```
































































